---
title: 谈一下接口安全
tags: [后台安全]
categories: [后端,安全]
comments: true
date: 2020-08-14 10:35:20
updated: 2020-08-14 10:35:20
description:
---
此处安全非指SQL注入、XSS等web安全，而是指业务安全，比如权限、伪造参数等，包括但不限于http以及其他rpc协议的接口。  
举个栗子，很多业务春节活动都会发红包，那么有一个独立的发红包服务，如何分配、控制接口的权限等安全？如何应对发放失败问题？这里提供几个思路，欢迎一起探讨，欢迎指出错误。

## 1 https + client证书

日常我们使用https，都是client校验server证书；实际上，也可以给用户分配client证书，以验证客户端身份。

### 1.1 优点

可以有效保证server/client身份的真实性，只要client证书不泄露，就可保证client调用是正常的。

### 1.2 缺点

1. 不支持http，性能没有http好
2. 若使用内网捕获的请求，直接重放，还是可以突破限制（很多时候是无意的，比如安全同事对接口的扫描；或测试环境的流量录制重放）

## 2 client ip白名单

server只处理来自源ip在白名单内的请求。

### 2.1 优点

1. 一个大胆的想法，除非在client出口网关处，做tcp/ip包级别的解析伪造，其他情况可以保证安全。
2. 改造简单，甚至无需改造

### 2.2 缺点

1. 未解决请求重放问题
2. 不适用于client ip经常发生变化的场景，比如ADSL拨号、服务自动扩容等

## 3 token 加密

该token仅保存在client和server本地，不应该在请求里携带原始token，避免泄露。常见的是，用做加密或签名算法的key，。一般情况，用签名算法，比如md5(params+key)。加密算法，加密后的数据会特别长，影响性能。

### 3.1 优点

实现简单、改造简单

### 3.2 缺点

未解决请求重放问题，可以用以下两种思路优化一下。

### 3.3 优化一：增加 随机数、时间戳 参数

以md5(params+key)为例：  

1. params增加`随机数`，使用redis检测是否重复。但不可能永久保存所有的随机数，随着累积，随机数冲突的概率会越来越大。因此需要给随机数增加时效性，比如半个小时过期。可解决半个小时内的重放问题。
2. params增加`时间戳`，接口增加逻辑，检测时间戳是否在前后十分钟。防止随机数过期后，使用之前的请求重放攻击。可解决在半个小时候的重放问题（因为请求带的时间戳不在有效期）。  

不用担心`随机数`或`时间戳`被伪造，如果被伪造了，签名会通不过。

#### 3.3.1 优化一优点

1. 实现简单，改造方便

#### 3.3.2 优化一缺点

1. 要求client与server时区一致，并且时间偏差不大。
2. 丢包/服务超时，可能会误使client认为请求失败，并重新请求。如果是充值、转账类接口，会导致server处理多次。此时需要幂等。

### 3.4 优化二：幂等

以md5(params+key)为例  

1. 增加`订单id`参数，server实现同一订单id处理的幂等性。client保证不同请求的`订单id`不重复，重试请求的`订单id`不变。
2. 加密params也增加`订单id`，防止订单id伪造。

#### 3.4.1 优化二优点

 1. 可以从数据层面最大程度保证安全
 2. 配合appid + token，可以作为一个支付系统的基本安全机制

#### 3.4.2 优化二缺点

 1. 实现、改造成本较高：要求client和server都支持订单id，**client要保证生成的订单id不重复，并且重试时订单id不变。server要保证订单处理的幂等性。** 

## 4 微信支付，企业付款接口安全分析

该接口可以通过商户号，给微信用户转账。

### 4.1 文档地址

https://pay.weixin.qq.com/wiki/doc/api/tools/mch_pay.php?chapter=14_2

### 4.2 主要有以下安全措施

1. 限定https: 防范中间人
2. client证书：client身份校验
3. ip白名单: client鉴权
4. md5签名: 见上文，文档：https://pay.weixin.qq.com/wiki/doc/api/tools/mch_pay.php?chapter=4_3
5. 随机字符串: 增加签名校验逆向难度
6. 订单id + server订单处理时的幂等性

### 4.3 分析

感觉安全限制是非常严格了。。。。  

1. 不知server有未对随机数进行去重，但由于server订单处理的幂等性，基本可以应对重放攻击的问题。
2. 若想破解，要同时解决：client证书、ip白名单、md5key三个问题。

## 5. QQ钱包，企业付款接口安全分析

该接口可以通过商户号，给QQ用户转账。

### 5.1 文档地址

https://qpay.qq.com/buss/wiki/206/1215

### 5.2 安全措施

1. 限定https：防范中间人
2. client证书：client身份鉴权
3. md5签名，与微信支付类似
4. 不超过32位的随机字符串：增加签名校验逆向难度
5. 订单id + server订单处理时的幂等性
6. op_user_id和md5(passwd)：商户操作员账号和密码

### 5.3 分析

1. 和微信接口的区别在于，微信支付接口多了ip白名单；QQ支付接口多了账号和密码
2. 若想破解，要同时解决：client证书、md5key、op_user账号三个问题。

## 6. 总结一下

问题可以分为两类，应对非法请求的鉴权，和应对合理请求的重试。

### 6.1 非法请求鉴权

1. https：防范中间人，防止数据被嗅探，以及确认server合法性
2. client证书：确认client身份
3. ip白名单
4. appid + token签名 + 随机字符串 + 时间戳：应对重放攻击和请求篡改

### 6.2 合法请求重试

1. 引入订单id和幂等处理：client生成不重复的订单id，服务端处理时保证幂等操作。